<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§³ æ‰“åŒ…è¡Œæ âœ¨ (å®Œæ•´ä¿®å¾©ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body { font-family: 'Nunito', 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #fcf9f2 0%, #f0f4f8 100%); color: #5c5c5c; max-width: 600px; margin: 0 auto; padding: 20px 20px 100px 20px; min-height: 100vh; box-sizing: border-box; }
        h1 { text-align: center; color: #7f95a3; font-weight: 900; margin-bottom: 20px; letter-spacing: 2px; }

        /* --- é ‚éƒ¨æŒ‰éˆ•èˆ‡æ‡¸æµ®æŒ‰éˆ• --- */
        .top-action-bar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .action-btn { border: none; font-size: 0.9em; cursor: pointer; padding: 8px 14px; border-radius: 12px; transition: 0.2s; font-weight: 800; display: inline-flex; align-items: center; gap: 5px; }
        .clear-btn { background: #fdf5f5; color: #d8a7a7; } .clear-btn:hover { background: #d8a7a7; color: white; transform: scale(1.05); }
        .share-btn { background: #e6f5ea; color: #7ab88b; } .share-btn:hover { background: #7ab88b; color: white; transform: scale(1.05); }
        .setting-btn { background: #ece6f5; color: #937ab8; } .setting-btn:hover { background: #937ab8; color: white; transform: scale(1.05); }

        .fab-btn { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; border-radius: 50%; background: #d8a7a7; color: white; border: none; box-shadow: 0 6px 15px rgba(216, 167, 167, 0.4); font-size: 1.8em; cursor: pointer; z-index: 100; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .fab-btn:hover { transform: scale(1.08) rotate(5deg); background: #cc9797; }
        .magic-btn { position: fixed; bottom: 30px; left: 30px; width: 65px; height: 65px; border-radius: 50%; background: #9ab4c2; color: white; border: none; box-shadow: 0 6px 15px rgba(154, 180, 194, 0.4); font-size: 1.8em; cursor: pointer; z-index: 100; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .magic-btn:hover { transform: scale(1.08) rotate(-5deg); background: #8ba5b3; }

        /* --- å½ˆçª—èˆ‡è¡¨å–®è¨­è¨ˆ --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(90, 100, 110, 0.4); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { position: relative; background: #fffcf8; width: 90%; max-width: 400px; border-radius: 24px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(30px) scale(0.95); } to { transform: translateY(0) scale(1); } }
        .close-btn { position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; color: #888; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .close-btn:hover { background: #e0e0e0; color: #555; }
        .modal-content h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.3em; color: #7f95a3; text-align: center; }
        .modal-subtitle { text-align: center; color: #8c8c8c; font-size: 0.9em; margin-bottom: 15px; line-height: 1.5; }

        .input-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; }
        .input-group select, .input-group input, .input-group textarea { width: 100%; box-sizing: border-box; padding: 14px; border: 2px solid #e8e6e1; border-radius: 16px; font-size: 0.95em; background: #fdfdfc; outline: none; transition: 0.3s; font-family: inherit; color: #5c5c5c; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { border-color: #c4d4db; background: #fff; }
        
        .magic-mode-container { display: flex; flex-direction: column; gap: 8px; background: #f6f8fa; padding: 12px 15px; border-radius: 14px; border: 1px dashed #c4d4db; margin-bottom: 15px; }
        .magic-mode-container label { display: flex; align-items: center; gap: 8px; font-size: 0.95em; color: #5c5c5c; cursor: pointer; }
        .magic-mode-container input[type="radio"] { cursor: pointer; transform: scale(1.1); accent-color: #9ab4c2; }

        .add-btn { background: #d8a7a7; color: white; border: none; padding: 15px; border-radius: 16px; cursor: pointer; font-weight: 800; font-size: 1.1em; width: 100%; transition: 0.2s; margin-top: 10px; box-shadow: 0 4px 10px rgba(216, 167, 167, 0.3); }
        .add-btn:hover { transform: translateY(-2px); background: #cc9797; }
        .magic-submit-btn { background: #9ab4c2; box-shadow: 0 4px 10px rgba(154, 180, 194, 0.3); }
        .magic-submit-btn:hover { background: #8ba5b3; }
        .magic-submit-btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }
        .edit-submit-btn { background: #7ab88b; box-shadow: 0 4px 10px rgba(122, 184, 139, 0.3); }
        .edit-submit-btn:hover { background: #6da37c; }

        /* --- âœ¨ é—œéµå­—æ¨™ç±¤æ¨£å¼ (ä¿®å¾©åŠ å›) âœ¨ --- */
        .keyword-panel { margin-bottom: 15px; }
        .keyword-group-title { font-size: 0.85em; color: #8ba5b3; margin-bottom: 8px; font-weight: bold; }
        .keyword-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .kw-tag { background: #f0f4f8; color: #7f95a3; font-size: 0.85em; padding: 6px 12px; border-radius: 20px; cursor: pointer; border: 1px solid #e1e8ed; transition: 0.2s; font-weight: 700; display: inline-block;}
        .kw-tag:hover { background: #9ab4c2; color: #fff; border-color: #9ab4c2; transform: translateY(-2px); }
        .history-tag { background: #fdf5f5; color: #d8a7a7; border-color: #f7e1e1; }
        .history-tag:hover { background: #d8a7a7; color: #fff; border-color: #d8a7a7; }

        .share-option-btn { background: #fff; color: #5c5c5c; border: 2px solid #e8e6e1; padding: 15px; border-radius: 16px; cursor: pointer; font-weight: 800; font-size: 1em; width: 100%; transition: 0.2s; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .share-option-btn:hover { background: #f0f4f8; border-color: #9ab4c2; color: #7f95a3;}

        /* --- æ¸…å–®èˆ‡ä»»å‹™å¡ç‰‡ --- */
        .date-section { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border-radius: 24px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(140, 150, 160, 0.05); }
        .date-title { font-size: 1.25em; font-weight: 900; margin-bottom: 15px; color: #6a7b87; padding-bottom: 12px; border-bottom: 2px dashed #e8e6e1; }
        .category-header { font-size: 0.95em; font-weight: 800; margin: 20px 0 10px 0; padding-left: 5px; color: #8c8c8c; display: flex; align-items: center; }
        
        .task-item { display: flex; align-items: center; margin-bottom: 12px; padding: 14px; background: #fff; border-radius: 16px; border: 1px solid #f2f0ec; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
        .task-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .task-item input[type="checkbox"] { display: none; }
        .check-icon { font-size: 1.5em; margin-right: 14px; cursor: pointer; transition: 0.3s; user-select: none; }
        .check-icon::before { content: 'âšª'; opacity: 0.3; }
        input[type="checkbox"]:checked + .check-icon::before { content: 'ğŸŒ¸'; opacity: 1; filter: saturate(0.8); }
        input[type="checkbox"]:checked + .check-icon { transform: scale(1.1); }
        
        .task-content { flex-grow: 1; }
        .task-title { font-weight: 700; margin-bottom: 4px; font-size: 1.05em; color: #5c5c5c; display: flex; align-items: center; gap: 8px;}
        .task-note { font-size: 0.85em; color: #9c9c9c; background: #f7f6f4; padding: 6px 10px; border-radius: 8px; display: inline-block; margin-top: 4px;}
        .completed .task-title { text-decoration: line-through; color: #c4c4c4; }
        .completed .task-note { opacity: 0.5; }
        
        .category-tag { font-size: 0.75em; padding: 4px 10px; border-radius: 12px; font-weight: 800; }
        .task-actions { display: flex; gap: 6px; margin-left: 10px; }
        .delete-btn { background: #fdf5f5; color: #d8a7a7; border: none; font-size: 1em; cursor: pointer; padding: 8px; border-radius: 10px; transition: 0.2s; }
        .delete-btn:hover { background: #d8a7a7; color: white; transform: scale(1.1); }
        .edit-btn { background: #f0f4f8; color: #7f95a3; border: none; font-size: 1em; cursor: pointer; padding: 8px; border-radius: 10px; transition: 0.2s; }
        .edit-btn:hover { background: #9ab4c2; color: white; transform: scale(1.1); }
    </style>
</head>
<body>

    <h1>è¬èƒ½æ‰“åŒ…ç¥å™¨ ğŸ§³</h1>
    
    <div id="top-bar" class="top-action-bar">
        <button class="action-btn setting-btn" onclick="openSettingModal()">âš™ï¸ AI å¼•æ“åˆ‡æ›</button>
        <button class="action-btn share-btn" onclick="openShareModal()" id="btn-share" style="display:none;">ğŸ“¤ åˆ†äº«/å…±ç”¨</button>
        <button class="action-btn clear-btn" onclick="clearAllData()" id="btn-clear" style="display:none;">ğŸ§¹ æ¸…ç©º</button>
    </div>

    <div id="app"></div>

    <button class="magic-btn" onclick="openMagicModal()" title="æ™ºæ…§ç”¢ç”Ÿæ¸…å–®">ğŸ’¡</button>
    <button class="fab-btn" onclick="openModal()" title="æ‰‹å‹•æ–°å¢å¾…è¾¦">â•</button>

    <div id="settingModal" class="modal-overlay" onclick="closeModalOnOutsideClick(event, 'settingModal')">
        <div class="modal-content" style="border-color: #cba6e8;">
            <button class="close-btn" onclick="closeModal('settingModal')">âœ–</button>
            <h3 style="color: #937ab8;">âš™ï¸ é¸æ“‡æ‚¨çš„æ™ºæ…§å¼•æ“</h3>
            <p class="modal-subtitle" style="text-align: left; font-size: 0.85em; color: #666;">
                <b>ğŸ’¡ å…§å»ºè¶…é€Ÿå¼•æ“ (é è¨­)ï¼š</b>å…é‡‘é‘°ã€ç¬é–“ç”¢å‡ºå¯¦ç”¨æ¸…å–®ã€‚<br><br>
                <b>ğŸ§  çœŸãƒ»AI å¼•æ“ï¼š</b>å¯è²¼ä¸Š API Key è§£é–æ¥µè‡´å®¢è£½åŒ–å¤§è…¦ï¼<br>
                <span style="color: #d8a7a7; font-size: 0.85em;">*è‹¥æœªå¡«å¯«æˆ–å‘¼å«å¤±æ•—ï¼Œå°‡è‡ªå‹•åˆ‡æ›å›å…§å»ºå¼•æ“ã€‚</span>
            </p>
            <div class="input-group">
                <select id="api-provider-select" onchange="updateApiTips()">
                    <option value="gemini">ğŸ§  Google Gemini (æ¨è–¦ï¼Œæœ‰å…è²»é¡åº¦)</option>
                    <option value="openai">ğŸ’¬ OpenAI ChatGPT (gpt-4o-mini)</option>
                </select>
                <div id="api-tips" style="font-size: 0.8em; color: #7ab88b; margin-top: -5px; padding-left: 5px;"></div>
                <input type="password" id="api-key-input" placeholder="å¯ç•™ç©ºã€‚è‹¥è¦å•Ÿç”¨çœŸAIï¼Œè«‹è²¼ä¸Šé‡‘é‘°">
            </div>
            <button class="add-btn setting-btn" style="background:#937ab8;" onclick="saveApiKey()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <div id="addModal" class="modal-overlay" onclick="closeModalOnOutsideClick(event, 'addModal')">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('addModal')">âœ–</button>
            <h3>æ–°å¢å¾…è¾¦é …ç›® âœ¨</h3>
            <div class="input-group">
                <select id="new-date-select" onchange="toggleCustomDate()"></select>
                <input type="date" id="new-date-input" style="display: none;">
                <select id="new-category-select" onchange="toggleCustomCategory()" style="display: none;"></select>
                <input type="text" id="new-category-input" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨± (ä¾‹: ğŸ‘• è¡£ç‰©)">
            </div>
            <div class="input-group">
                <input type="text" id="new-title" placeholder="ç‰©å“åç¨±* (å¿…å¡«)">
                <input type="text" id="new-note" placeholder="å‚™è¨»ç´°ç¯€ (é¸å¡«)">
            </div>
            <button class="add-btn" onclick="addNewTask()">åŠ å…¥æ¸…å–®</button>
        </div>
    </div>

    <div id="editModal" class="modal-overlay" onclick="closeModalOnOutsideClick(event, 'editModal')">
        <div class="modal-content" style="border-color: #a1d6b2;">
            <button class="close-btn" onclick="closeModal('editModal')">âœ–</button>
            <h3 style="color: #7ab88b;">ç·¨è¼¯å¾…è¾¦é …ç›® âœï¸</h3>
            <div class="input-group">
                <select id="edit-date-select" onchange="toggleEditCustomDate()"></select>
                <input type="date" id="edit-date-input" style="display: none;">
                <select id="edit-category-select" onchange="toggleEditCustomCategory()"></select>
                <input type="text" id="edit-category-input" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±" style="display: none;">
            </div>
            <div class="input-group">
                <input type="text" id="edit-title" placeholder="ç‰©å“åç¨±* (å¿…å¡«)">
                <input type="text" id="edit-note" placeholder="å‚™è¨»ç´°ç¯€ (é¸å¡«)">
            </div>
            <button class="add-btn edit-submit-btn" onclick="saveEditTask()">å„²å­˜ä¿®æ”¹</button>
        </div>
    </div>

    <div id="magicModal" class="modal-overlay" onclick="closeModalOnOutsideClick(event, 'magicModal')">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('magicModal')">âœ–</button>
            <h3>å…¨èƒ½æ‰“åŒ…å°å¹«æ‰‹ ğŸ’¡</h3>
            <p class="modal-subtitle">é»æ“Šä¸‹æ–¹æ¨™ç±¤ï¼Œæˆ–ç›´æ¥è¼¸å…¥ä»»ä½•å¤©é¦¬è¡Œç©ºçš„è¡Œç¨‹ï¼</p>
            
            <div class="keyword-panel">
                <div class="keyword-group-title">ğŸ’¡ é»æ“ŠåŠ å…¥æ¨è–¦é—œéµå­—ï¼š</div>
                <div class="keyword-tags">
                    <span class="kw-tag" onclick="appendKeyword('å‡ºåœ‹')">âœˆï¸ å‡ºåœ‹</span>
                    <span class="kw-tag" onclick="appendKeyword('å¸¶é•·è¼©')">ğŸ‘µ å¸¶é•·è¼©</span>
                    <span class="kw-tag" onclick="appendKeyword('å¸¶å¯¶å¯¶')">ğŸ¼ å¸¶å¯¶å¯¶</span>
                    <span class="kw-tag" onclick="appendKeyword('è¡Œå‹•ä¸ä¾¿')">ğŸ¦½ è¡Œå‹•ä¸ä¾¿</span>
                    <span class="kw-tag" onclick="appendKeyword('å¸¶å¯µç‰©')">ğŸ• å¸¶å¯µç‰©</span>
                    <span class="kw-tag" onclick="appendKeyword('é–‹è»Šè‡ªé§•')">ğŸš— é–‹è»Šè‡ªé§•</span>
                    <span class="kw-tag" onclick="appendKeyword('å†¬å¤©')">â„ï¸ å†¬å¤©</span>
                    <span class="kw-tag" onclick="appendKeyword('æµ·é‚Šç©æ°´')">ğŸ–ï¸ æµ·é‚Šç©æ°´</span>
                    <span class="kw-tag" onclick="appendKeyword('ä¸‰å¤©å…©å¤œ')">ğŸ’ ä¸‰å¤©å…©å¤œ</span>
                </div>
                
                <div class="keyword-group-title" id="history-title" style="display: none; margin-top: 15px;">ğŸ•’ æœ€è¿‘è¼¸å…¥é (é»æ“Šç›´æ¥å¸¶å…¥)ï¼š</div>
                <div id="history-keywords" class="keyword-tags"></div>
            </div>

            <div class="input-group">
                <textarea id="magic-prompt" rows="3" placeholder="ä¾‹å¦‚ï¼šå¸¶å®¹æ˜“ç·Šå¼µçš„æŸ´çŠ¬å»åŒ—æµ·é“çœ‹é›ªäº”å¤©å››å¤œï¼Œæˆ‘å®¹æ˜“èƒƒç—›ï¼Œè€Œä¸”å–œæ­¡æ”å½±..."></textarea>
            </div>

            <div id="magic-mode-group" class="magic-mode-container" style="display: none;">
                <div style="font-size: 0.85em; color: #8ba5b3; margin-bottom: 4px; font-weight: bold;">ç™¼ç¾ç¾æœ‰æ¸…å–®ï¼Œæ‚¨å¸Œæœ›ï¼š</div>
                <label><input type="radio" name="magic-mode" value="append" checked> â• é™„åŠ åœ¨ç¾æœ‰æ¸…å–®ä¸‹</label>
                <label><input type="radio" name="magic-mode" value="overwrite"> ğŸ—‘ï¸ æ¸…ç©ºä¸¦é‡æ–°ç”Ÿæˆ</label>
            </div>

            <button id="magic-submit-btn" class="add-btn magic-submit-btn" onclick="runMagicEngine()">âœ¨ ç”¢ç”Ÿå°ˆå±¬æ¸…å–®</button>
        </div>
    </div>

    <div id="shareModal" class="modal-overlay" onclick="closeModalOnOutsideClick(event, 'shareModal')">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('shareModal')">âœ–</button>
            <h3>ğŸ“¤ åˆ†äº«çµ¦ç¥éšŠå‹</h3>
            <p class="modal-subtitle">è«‹é¸æ“‡æ‚¨æƒ³è¦çš„åˆ†äº«æ–¹å¼ï¼š</p>
            <button class="share-option-btn" onclick="copyAsText()">ğŸ“ è¤‡è£½ç´”æ–‡å­— (é©åˆè²¼åˆ° LINE)</button>
            <button class="share-option-btn" onclick="copyMagicLink()" style="border-color: #9ab4c2; color: #7f95a3;">ğŸ”— è¤‡è£½é­”æ³•é€£çµ (åŒ¯å…¥åˆ°å°æ–¹æ‰‹æ©Ÿ)</button>
        </div>
    </div>

    <script>
        // --- è³‡æ–™åˆå§‹åŒ– ---
        let data = { "checklists": [] };
        let magicHistory = [];
        let editingTaskId = null;
        let editingTaskOldDate = null;
        const appDiv = document.getElementById('app');

        const categoryStyles = {
            "ğŸ’³ é‡è¦å¿…å‚™": { bg: "#f5e6e6", color: "#b87a7a", line: "#d6a1a1" }, 
            "âœˆï¸ å‡ºåœ‹å°ˆå±¬": { bg: "#f5eee6", color: "#b8957a", line: "#d6bba1" }, 
            "ğŸ‘• è¡£ç‰©ç©¿æ­": { bg: "#e6eef5", color: "#7a9cb8", line: "#a1bcd6" }, 
            "ğŸ§´ å€‹äººè­·ç†": { bg: "#e6f5ea", color: "#7ab88b", line: "#a1d6b2" }, 
            "ğŸ”Œ 3Cé›»å­": { bg: "#ece6f5", color: "#937ab8", line: "#bca1d6" }, 
            "ğŸ¥£ é£²é£Ÿç›¸é—œ": { bg: "#f5ebe6", color: "#b88a7a", line: "#d6aca1" }, 
            "ğŸ¼ å¯¶å¯¶å°ˆå±¬": { bg: "#f5e6ee", color: "#b87a9f", line: "#d6a1c1" }, 
            "ğŸ‘µ é•·è¼©å°ˆå±¬": { bg: "#f0e6f5", color: "#8c7ab8", line: "#c1a1d6" }, 
            "ğŸ¦½ ç„¡éšœç¤™è¼”å…·": { bg: "#e6eef5", color: "#7a9cb8", line: "#a1bcd6" }, 
            "â„ï¸ å†¬å­£ä¿æš–": { bg: "#e6f1f5", color: "#7aaab8", line: "#a1c7d6" }, 
            "ğŸ–ï¸ ç©æ°´è£å‚™": { bg: "#e6f5f3", color: "#7ab8ae", line: "#a1d6ce" }, 
            "ğŸ•ï¸ æˆ¶å¤–éœ²ç‡Ÿ": { bg: "#edf5e6", color: "#96b87a", line: "#b8d6a1" }, 
            "ğŸ’¼ å•†å‹™å·¥ä½œ": { bg: "#ebebeb", color: "#7a7a7a", line: "#b3b3b3" }, 
            "ğŸš— äº¤é€šè‡ªé§•": { bg: "#eef5e6", color: "#9fb87a", line: "#c2d6a1" }, 
            "ğŸ• å¯µç‰©å°ˆå±¬": { bg: "#f5eee6", color: "#b8957a", line: "#d6bba1" },
            "ğŸ“ å…¶ä»–é›œé …": { bg: "#f0f0f0", color: "#8c8c8c", line: "#cccccc" }  
        };
        const fallbackStyles = [ { bg: "#f5f3ed", color: "#a39b8a", line: "#d1cbb8" }, { bg: "#f0f4f8", color: "#7a9cb8", line: "#a1bcd6" }, { bg: "#f5e6e6", color: "#b87a7a", line: "#d6a1a1" }, { bg: "#e6f5ea", color: "#7ab88b", line: "#a1d6b2" }, { bg: "#ece6f5", color: "#937ab8", line: "#bca1d6" } ];

        function getCategoryStyle(catName) {
            if (categoryStyles[catName]) return categoryStyles[catName];
            let charCodeSum = 0; for(let i = 0; i < catName.length; i++) charCodeSum += catName.charCodeAt(i);
            return fallbackStyles[charCodeSum % fallbackStyles.length];
        }

        // --- è³‡æ–™è®€å¯«èˆ‡æª¢æŸ¥åŒ¯å…¥ ---
        function checkImportData() {
            if(window.location.hash && window.location.hash.startsWith('#share=')) {
                try {
                    const encodedData = window.location.hash.substring(7);
                    const decodedStr = decodeURIComponent(atob(encodedData));
                    const importedData = JSON.parse(decodedStr);
                    if(importedData && importedData.checklists) {
                        if(confirm("ğŸ“¦ åµæ¸¬åˆ°åˆ¥äººåˆ†äº«çš„æ¸…å–®ï¼\næ˜¯å¦è¦åŒ¯å…¥ä¸¦è¦†è“‹æ‚¨ç›®å‰çš„æ¸…å–®ï¼Ÿ")) {
                            data = importedData; saveData(); alert("âœ… åŒ¯å…¥æˆåŠŸï¼");
                        }
                    }
                    history.replaceState(null, null, ' ');
                } catch(e) {}
            }
        }

        function loadData() {
            checkImportData(); 
            const savedData = localStorage.getItem('aesthetic-trip-ultimate'); 
            if (savedData) data = JSON.parse(savedData);
            const savedHistory = localStorage.getItem('magic-history-ultimate');
            if (savedHistory) magicHistory = JSON.parse(savedHistory);
        }
        function saveData() { localStorage.setItem('aesthetic-trip-ultimate', JSON.stringify(data)); }
        function saveHistory(prompt) {
            magicHistory = magicHistory.filter(item => item !== prompt); magicHistory.unshift(prompt);
            if (magicHistory.length > 3) magicHistory.pop(); localStorage.setItem('magic-history-ultimate', JSON.stringify(magicHistory));
        }

        // --- å½ˆçª—é€šç”¨æ§åˆ¶ ---
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function closeModalOnOutsideClick(event, modalId) { if (event.target === document.getElementById(modalId)) closeModal(modalId); }

        // --- åŠŸèƒ½ï¼šä¸€éµæ¸…ç©º ---
        function clearAllData() {
            if (data.checklists.length === 0) return;
            if (confirm("ç¢ºå®šè¦ã€Œä¸€éµæ¸…ç©ºã€æ‰€æœ‰æ¸…å–®å—ï¼Ÿ\né€™å€‹å‹•ä½œç„¡æ³•å¾©åŸå–”ï¼ğŸ§¹")) { 
                data.checklists = []; saveData(); renderTasks(); 
            }
        }

        // --- åŠŸèƒ½ï¼šåˆªé™¤é …ç›® (ä¿®å¾©é˜²å‘†å‚³åƒ) ---
        function deleteTask(dateString, taskId, taskTitle) {
            const safeTitle = taskTitle || 'æ­¤é …ç›®';
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${safeTitle}ã€å—ï¼ŸğŸ—‘ï¸`)) {
                const dayIndex = data.checklists.findIndex(d => d.date === dateString);
                if (dayIndex !== -1) {
                    data.checklists[dayIndex].tasks = data.checklists[dayIndex].tasks.filter(t => t.id !== taskId);
                    if (data.checklists[dayIndex].tasks.length === 0) data.checklists.splice(dayIndex, 1);
                    saveData(); renderTasks();
                }
            }
        }

        // --- API è¨­å®š ---
        function updateApiTips() {
            const provider = document.getElementById('api-provider-select').value;
            const tipsEl = document.getElementById('api-tips');
            if(provider === 'gemini') tipsEl.innerHTML = 'ğŸ‘‰ å‰å¾€ <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #9ab4c2;">Google AI Studio</a> ç”³è«‹ (å…ç¶å¡)';
            else tipsEl.innerHTML = 'ğŸ‘‰ å‰å¾€ <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #9ab4c2;">OpenAI Platform</a> ç”³è«‹ (éœ€æœ‰é¡åº¦)';
        }

        function openSettingModal() {
            document.getElementById('settingModal').style.display = 'flex';
            document.getElementById('api-provider-select').value = localStorage.getItem('univ_api_provider') || 'gemini';
            document.getElementById('api-key-input').value = localStorage.getItem('univ_api_key') || '';
            updateApiTips();
        }

        function saveApiKey() {
            const provider = document.getElementById('api-provider-select').value;
            const key = document.getElementById('api-key-input').value.trim();
            localStorage.setItem('univ_api_provider', provider);
            if(key) {
                localStorage.setItem('univ_api_key', key);
                alert(`âœ… è¨­å®šæˆåŠŸï¼ç³»çµ±å·²æ›è¼‰çœŸÂ·AI å¤§è…¦ã€‚`);
            } else {
                localStorage.removeItem('univ_api_key');
                alert(`ğŸ’¡ é‡‘é‘°å·²æ¸…é™¤ã€‚ç³»çµ±å°‡ä½¿ç”¨ã€Œæ¥µé€Ÿå…§å»ºæ™ºæ…§å¼•æ“ã€ç‚ºæ‚¨æœå‹™ã€‚`);
            }
            closeModal('settingModal');
        }

        // --- åˆ†äº«åŠŸèƒ½ ---
        function openShareModal() { document.getElementById('shareModal').style.display = 'flex'; }
        function copyAsText() {
            let textOutput = "ğŸ§³ æˆ‘çš„æ‰“åŒ…æ¸…å–®\n-------------------\n";
            data.checklists.forEach(day => {
                textOutput += `\n${day.date === 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨' ? 'ğŸ’ æ™ºæ…§å¿«é€Ÿç¸½è¡¨' : 'ğŸ—“ï¸ ' + day.date}\n`;
                const grouped = {}; day.tasks.forEach(t => { if(!grouped[t.category]) grouped[t.category]=[]; grouped[t.category].push(t); });
                Object.keys(grouped).sort().forEach(cat => {
                    textOutput += `ã€${cat}ã€‘\n`; grouped[cat].forEach(t => { textOutput += `${t.isCompleted ? "âœ…" : "âšª"} ${t.title}${t.note ? ` (${t.note})` : ""}\n`; });
                });
            });
            navigator.clipboard.writeText(textOutput).then(() => { alert("ğŸ“ è¤‡è£½æˆåŠŸï¼å¯ä»¥ç›´æ¥è²¼åˆ° LINE å›‰ï¼"); closeModal('shareModal'); });
        }
        function copyMagicLink() {
            try {
                const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
                navigator.clipboard.writeText(`${window.location.href.split('#')[0]}#share=${encoded}`).then(() => { alert("ğŸ”— é­”æ³•é€£çµè¤‡è£½æˆåŠŸï¼"); closeModal('shareModal'); });
            } catch(e) { alert("æ¸…å–®éå¤§ï¼Œç„¡æ³•ç”¢ç”Ÿé€£çµã€‚"); }
        }

        // --- âœ¨ é—œéµå­—æ¨™ç±¤åŠŸèƒ½ âœ¨ ---
        function appendKeyword(keyword) {
            const textarea = document.getElementById('magic-prompt');
            let currentText = textarea.value.trim();
            textarea.value = currentText ? currentText + " " + keyword : keyword;
            textarea.focus();
        }

        function applyHistory(historyText) { 
            document.getElementById('magic-prompt').value = historyText; 
        }

        function renderHistoryTags() {
            const container = document.getElementById('history-keywords'); 
            const title = document.getElementById('history-title'); 
            container.innerHTML = '';
            if (magicHistory.length > 0) {
                title.style.display = 'block';
                magicHistory.forEach(text => {
                    const span = document.createElement('span'); span.className = 'kw-tag history-tag';
                    span.innerText = text.length > 15 ? text.substring(0, 15) + '...' : text;
                    span.title = text; span.onclick = () => applyHistory(text); container.appendChild(span);
                });
            } else { 
                title.style.display = 'none'; 
            }
        }

        // --- é¸å–®ç”Ÿæˆé‚è¼¯ ---
        function generateDateOptions(selectElement, defaultVal) {
            selectElement.innerHTML = ''; 
            const existingDates = data.checklists.map(d => d.date).filter(d => d !== 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨');
            existingDates.forEach(date => { const option = document.createElement('option'); option.value = date; option.text = `ğŸ—“ï¸ ${date}`; selectElement.appendChild(option); });
            const generalOption = document.createElement('option'); generalOption.value = 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨'; generalOption.text = 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨'; selectElement.appendChild(generalOption);
            const customOption = document.createElement('option'); customOption.value = 'custom'; customOption.text = 'â• æ–°å¢ç‰¹å®šæ—¥æœŸ...'; selectElement.appendChild(customOption);
            if (defaultVal && Array.from(selectElement.options).some(o => o.value === defaultVal)) selectElement.value = defaultVal;
            else if (existingDates.length > 0) selectElement.value = existingDates[0]; else selectElement.value = 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨';
        }

        function generateCategoryOptions(selectElement, inputElement, defaultVal) {
            selectElement.innerHTML = ''; const activeCategories = new Set();
            data.checklists.forEach(day => { day.tasks.forEach(task => { if (task.category) activeCategories.add(task.category); }); });
            if (activeCategories.size === 0) { selectElement.style.display = 'none'; inputElement.style.display = 'block'; inputElement.value = ''; } 
            else {
                selectElement.style.display = 'block';
                activeCategories.forEach(cat => { const option = document.createElement('option'); option.value = cat; option.text = cat; selectElement.appendChild(option); });
                const customOption = document.createElement('option'); customOption.value = 'custom'; customOption.text = 'â• è‡ªè¨‚æ–°åˆ†é¡...'; selectElement.appendChild(customOption);
                if (defaultVal && activeCategories.has(defaultVal)) { selectElement.value = defaultVal; inputElement.style.display = 'none'; inputElement.value = ''; } 
                else { selectElement.value = Array.from(activeCategories)[0]; inputElement.style.display = 'none'; inputElement.value = ''; }
            }
        }

        // --- æ–°å¢ / ç·¨è¼¯ é‚è¼¯ ---
        function openModal() { document.getElementById('addModal').style.display = 'flex'; generateDateOptions(document.getElementById('new-date-select')); toggleCustomDate(); generateCategoryOptions(document.getElementById('new-category-select'), document.getElementById('new-category-input')); }
        function toggleCustomDate() { document.getElementById('new-date-input').style.display = document.getElementById('new-date-select').value === 'custom' ? 'block' : 'none'; }
        function toggleCustomCategory() { document.getElementById('new-category-input').style.display = document.getElementById('new-category-select').value === 'custom' ? 'block' : 'none'; }

        function openEditModal(dateString, taskId) {
            editingTaskId = taskId; editingTaskOldDate = dateString;
            const day = data.checklists.find(d => d.date === dateString); const task = day.tasks.find(t => t.id === taskId);
            if(!task) return;
            document.getElementById('editModal').style.display = 'flex'; 
            generateDateOptions(document.getElementById('edit-date-select'), dateString); toggleEditCustomDate();
            generateCategoryOptions(document.getElementById('edit-category-select'), document.getElementById('edit-category-input'), task.category);
            document.getElementById('edit-title').value = task.title; document.getElementById('edit-note').value = task.note || '';
        }
        function toggleEditCustomDate() { document.getElementById('edit-date-input').style.display = document.getElementById('edit-date-select').value === 'custom' ? 'block' : 'none'; }
        function toggleEditCustomCategory() { document.getElementById('edit-category-input').style.display = document.getElementById('edit-category-select').value === 'custom' ? 'block' : 'none'; }

        function saveEditTask() {
            const dateSelect = document.getElementById('edit-date-select');
            let newDate = dateSelect.value === 'custom' ? document.getElementById('edit-date-input').value : dateSelect.value;
            if (dateSelect.value === 'custom' && !newDate) return alert("è«‹é¸æ“‡æ—¥æœŸå–”ï¼ğŸ—“ï¸");
            const catSelect = document.getElementById('edit-category-select'); const catInputEl = document.getElementById('edit-category-input');
            let newCat = (catSelect.style.display === 'none' || catSelect.value === 'custom') ? catInputEl.value.trim() : catSelect.value;
            if (!newCat) newCat = "ğŸ“ å…¶ä»–é›œé …"; 
            const newTitle = document.getElementById('edit-title').value.trim();
            if (!newTitle) return alert("è«‹è¼¸å…¥ç‰©å“åç¨±ï¼ğŸ“Œ");

            const oldDayIndex = data.checklists.findIndex(d => d.date === editingTaskOldDate);
            if(oldDayIndex !== -1) {
                let taskToMove = data.checklists[oldDayIndex].tasks.find(t => t.id === editingTaskId);
                if(taskToMove) {
                    data.checklists[oldDayIndex].tasks = data.checklists[oldDayIndex].tasks.filter(t => t.id !== editingTaskId);
                    if (data.checklists[oldDayIndex].tasks.length === 0) data.checklists.splice(oldDayIndex, 1);
                    
                    taskToMove.title = newTitle; taskToMove.category = newCat; taskToMove.note = document.getElementById('edit-note').value.trim();
                    let newDay = data.checklists.find(d => d.date === newDate);
                    if (newDay) { newDay.tasks.push(taskToMove); } else { data.checklists.push({ date: newDate, tasks: [taskToMove] }); }
                }
            }
            data.checklists.sort((a, b) => { if (a.date === 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨') return -1; if (b.date === 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨') return 1; return a.date.localeCompare(b.date); });
            saveData(); renderTasks(); closeModal('editModal');
        }

        // --- æ™ºæ…§å¼•æ“æ ¸å¿ƒé‚è¼¯ ---
        function openMagicModal() { 
            document.getElementById('magicModal').style.display = 'flex'; 
            renderHistoryTags(); // æ¸²æŸ“æ¨™ç±¤
            const modeGroup = document.getElementById('magic-mode-group');
            if (data.checklists.length > 0) { modeGroup.style.display = 'flex'; document.querySelector('input[name="magic-mode"][value="append"]').checked = true; } 
            else { modeGroup.style.display = 'none'; }
        }

        // é›¢ç·šå…§å»ºè¦å‰‡
        function getRuleBasedTasks(input) {
            let days = 1;
            const dayMatch = input.match(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+)å¤©/);
            if (dayMatch) { const dayMap = {"ä¸€":1,"äºŒ":2,"å…©":2,"ä¸‰":3,"å››":4,"äº”":5,"å…­":6,"ä¸ƒ":7,"å…«":8,"ä¹":9,"å":10}; days = parseInt(dayMatch[1]) || dayMap[dayMatch[1]] || 1; }

            const isAbroad = /(å‡ºåœ‹|åœ‹å¤–|æµ·å¤–|æ—¥æœ¬|éŸ“åœ‹|æ³°åœ‹|æ­æ´²|é£›æ©Ÿ|æ©Ÿç¥¨|è­·ç…§|å‡ºå¢ƒ)/.test(input);
            const isFlight = /(å‡ºåœ‹|æµ·å¤–|é£›æ©Ÿ|æ­æ©Ÿ|æ©Ÿç¥¨)/.test(input);
            const isWinter = /(å†·|å†¬|é›ª|å¯’æµ|åŒ—æµ·é“|å†°å³¶|æ»‘é›ª)/.test(input);
            const isSummer = /(ç†±|å¤|é«˜æº«|é¿æš‘|ç‚ç†±|ä¸­æš‘)/.test(input);
            const isRain = /(é›¨|æ¢…é›¨|é¢±é¢¨|é›·é™£é›¨)/.test(input);
            const isCamp = /(å±±|éœ²ç‡Ÿ|éƒŠå¤–|æˆ¶å¤–|é‡é¤|ç™¾å²³)/.test(input);
            const isDrive = /(é–‹è»Š|è»Š|è‡ªé§•)/.test(input);
            const isBaby = /(å¯¶å¯¶|å¬°å…’|å°å­©|å…’å­|å¥³å…’)/.test(input);
            const isElderly = /(é•·è¼©|è€äºº|çˆ¶æ¯|çˆ¸åª½|é˜¿å…¬|é˜¿å¬¤)/.test(input);
            const isMobility = /(è¡Œå‹•ä¸ä¾¿|è¼ªæ¤…|æ‹æ–|ç„¡éšœç¤™|è¼”å…·)/.test(input);
            const isPet = /(å¯µç‰©|ç‹—|è²“|æŸ´çŠ¬|æ¯›å­©)/.test(input);
            
            let isBeach = /(æ°´|æµ·|æ²™ç˜|å¢¾ä¸|æ²–ç¹©|æ³³)/.test(input);
            if (isWinter && !/(æº«æ³‰|å®¤å…§æ³³æ± )/.test(input)) isBeach = false;
            let needThickCoat = isWinter; if (isSummer) needThickCoat = false;

            let magicTasks = [];

            magicTasks.push({ title: "éŒ¢åŒ… / ä¿¡ç”¨å¡ / ç¾é‡‘", category: "ğŸ’³ é‡è¦å¿…å‚™", note: "å‡ºé–€å‰å„ªå…ˆç¢ºèª" });
            magicTasks.push({ title: "å€‹äººèº«åˆ†è­‰ / å¥ä¿å¡", category: "ğŸ’³ é‡è¦å¿…å‚™", note: "" });
            magicTasks.push({ title: "æ‰‹æ©Ÿèˆ‡å……é›»ç·š", category: "ğŸ”Œ 3Cé›»å­", note: "" });

            if (isCamp) magicTasks.push({ title: "å¤§å®¹é‡è¡Œå‹•é›»æº", category: "ğŸ”Œ 3Cé›»å­", note: "âš ï¸ å±±å€å……é›»ä¸ä¾¿" });
            else magicTasks.push({ title: "è¡Œå‹•é›»æº", category: "ğŸ”Œ 3Cé›»å­", note: "è¨˜å¾—å…ˆå……é£½é›»" });

            if (isAbroad) {
                magicTasks.push({ title: "è­·ç…§", category: "âœˆï¸ å‡ºåœ‹å°ˆå±¬", note: "âš ï¸ æª¢æŸ¥æœ‰æ•ˆæœŸé™å¤§æ–¼å…­å€‹æœˆ" });
                magicTasks.push({ title: "ä¾†å›æ©Ÿç¥¨ / é›»å­ç™»æ©Ÿè­‰", category: "âœˆï¸ å‡ºåœ‹å°ˆå±¬", note: "" });
                magicTasks.push({ title: "ç•¶åœ°å¤–å¹£ç¾é‡‘", category: "âœˆï¸ å‡ºåœ‹å°ˆå±¬", note: `ç´„ NT$ ${days * 3000} ç­‰å€¼å‚™ç”¨` });
                magicTasks.push({ title: "æµ·å¤–ç¶²è·¯å¡ / eSIM", category: "âœˆï¸ å‡ºåœ‹å°ˆå±¬", note: "ç¢ºèªé–‹é€š" });
                magicTasks.push({ title: "è¬ç”¨è½‰æ¥é ­", category: "âœˆï¸ å‡ºåœ‹å°ˆå±¬", note: "ç¢ºèªæ’åº§å½¢ç‹€" });
            }

            if (isDrive) {
                if (isAbroad) magicTasks.push({ title: "å°ç£é§•ç…§ ï¼‹ åœ‹éš›é§•ç…§/è­¯æœ¬", category: "ğŸš— äº¤é€šè‡ªé§•", note: "âš ï¸ ç¼ºä¸€ä¸å¯" });
                else magicTasks.push({ title: "æ±½è»Šé§•ç…§", category: "ğŸš— äº¤é€šè‡ªé§•", note: "" });
            }

            magicTasks.push({ title: "æ›æ´—è¡£ç‰© (ä¸Šè¡£/è¤²å­)", category: "ğŸ‘• è¡£ç‰©ç©¿æ­", note: `å¸¶ ${days + 1} å¥—` });
            magicTasks.push({ title: "è²¼èº«å…§è¡£è¤² / è¥ªå­", category: "ğŸ‘• è¡£ç‰©ç©¿æ­", note: `å¸¶ ${days + 1} å¥—` });
            magicTasks.push({ title: "å¸¸å‚™è—¥å“", category: "ğŸ§´ å€‹äººè­·ç†", note: "è…¸èƒƒè—¥ã€æ­¢ç—›è—¥" });

            if (needThickCoat) {
                magicTasks.push({ title: "é˜²é¢¨ä¿æš–åšå¤–å¥—", category: "â„ï¸ å†¬å­£ä¿æš–", note: "" });
                magicTasks.push({ title: "ç™¼ç†±è¡£è¤² / æ¯›å¸½ / æ‰‹å¥—", category: "â„ï¸ å†¬å­£ä¿æš–", note: "æ´‹è”¥å¼ç©¿æ­" });
            }
            if (isBeach) {
                magicTasks.push({ title: "æ³³è¡£ / æµ·ç˜æ‹–é‹", category: "ğŸ–ï¸ ç©æ°´è£å‚™", note: "" });
                magicTasks.push({ title: "æµ·æ´‹å‹å–„é˜²æ›¬ä¹³", category: "ğŸ–ï¸ ç©æ°´è£å‚™", note: "ä¿è­·çŠç‘šç¾¤" });
            }
            if (isBaby) {
                magicTasks.push({ title: "å…’ç«¥æ‰‹å†Š / å¥ä¿å¡", category: "ğŸ’³ é‡è¦å¿…å‚™", note: "å°±é†«èº«åˆ†è­‰" });
                magicTasks.push({ title: "å¯¶å¯¶å°¿å¸ƒ", category: "ğŸ¼ å¯¶å¯¶å°ˆå±¬", note: `ç´„å¸¶ ${days * 7 + 3} ç‰‡` });
                magicTasks.push({ title: "å¥¶ç²‰ / å‰¯é£Ÿå“", category: "ğŸ¥£ é£²é£Ÿç›¸é—œ", note: `æº–å‚™ ${days + 1} å¤©ä»½é‡` });
                magicTasks.push({ title: "å¥¶ç“¶èˆ‡ä¿æº«ç“¶", category: "ğŸ¼ å¯¶å¯¶å°ˆå±¬", note: "å¸¶æ›¿æ›ç“¶" });
                magicTasks.push({ title: "ç´”æ°´æ¿•ç´™å·¾", category: "ğŸ¼ å¯¶å¯¶å°ˆå±¬", note: "å¸¶ 2 å¤§åŒ…" });
                magicTasks.push({ title: "è¼•ä¾¿æ¨è»Š", category: "ğŸš— äº¤é€šè‡ªé§•", note: "å‡ºéŠå¿…å‚™" });
            }
            if (isElderly) {
                magicTasks.push({ title: "æ…¢æ€§ç—…è—¥ç‰© / é€£çºŒè™•æ–¹ç®‹", category: "ğŸ‘µ é•·è¼©å°ˆå±¬", note: `âš ï¸ å‹™å¿…å¸¶è¶³ ${days + 3} å¤©ä»½é‡` });
                magicTasks.push({ title: "é˜²æ»‘æ°£å¢Šé‹", category: "ğŸ‘µ é•·è¼©å°ˆå±¬", note: "ä¿è­·è†è“‹é˜²è·Œå€’" });
                magicTasks.push({ title: "è¬é‡‘æ²¹ / ç— ç—›è²¼å¸ƒ", category: "ğŸ‘µ é•·è¼©å°ˆå±¬", note: "é˜²æšˆè»Šã€è§£ç— ç—›" });
            }
            if (isPet) {
                magicTasks.push({ title: "å¯µç‰©ç‰½ç¹© / èƒ¸èƒŒå¸¶", category: "ğŸ• å¯µç‰©å°ˆå±¬", note: "é˜²èµ°å¤±å¿…å‚™" });
                magicTasks.push({ title: "æ’¿ä¾¿è¢‹ / å°¿å¸ƒå¢Š", category: "ğŸ• å¯µç‰©å°ˆå±¬", note: "åšå€‹å¥½ä¸»äºº" });
                magicTasks.push({ title: "å¯µç‰©é£¼æ–™ / é›¶é£Ÿ", category: "ğŸ• å¯µç‰©å°ˆå±¬", note: "å®‰æ’«æƒ…ç·’" });
            }

            return magicTasks;
        }

        async function runMagicEngine() {
            const input = document.getElementById('magic-prompt').value;
            if (!input.trim()) return alert("è«‹è¼¸å…¥æ‚¨çš„è¡Œç¨‹å–”ï¼ğŸ’¡");
            saveHistory(input.trim());

            const apiKey = localStorage.getItem('univ_api_key');
            const provider = localStorage.getItem('univ_api_provider') || 'gemini';
            const btn = document.getElementById('magic-submit-btn');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;

            let finalTasks = [];

            if (apiKey) {
                btn.innerHTML = 'ğŸ§  çœŸãƒ»AI æ·±åº¦æ€è€ƒä¸­... (ç´„5~10ç§’)';
                const promptText = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¡Œææ‰“åŒ…åŠ©ç†ã€‚è«‹é–±è®€è¡Œç¨‹ï¼šã€Œ${input}ã€ï¼Œæ€è€ƒå¯èƒ½çš„çªç™¼ç‹€æ³ã€å¤©æ°£ã€äººç‰©å±¬æ€§(é•·è¼©/å¬°å…’/å¯µç‰©ç­‰)ã€äº¤é€šå·¥å…·ï¼Œåˆ—å‡ºè¶…è©³ç´°æ¸…å–®ã€‚
è«‹åš´æ ¼å›å‚³JSON Arrayï¼Œæ ¼å¼å¦‚ï¼š[{"title": "ç‰©å“åç¨±","category": "åˆ†é¡åç¨±é™„Emoji","note": "å‚™è¨»èªªæ˜"}]
æ¨è–¦åˆ†é¡: ğŸ’³ é‡è¦å¿…å‚™, âœˆï¸ å‡ºåœ‹å°ˆå±¬, ğŸ‘• è¡£ç‰©ç©¿æ­, ğŸ§´ å€‹äººè­·ç†, ğŸ”Œ 3Cé›»å­, ğŸ¥£ é£²é£Ÿç›¸é—œ, ğŸ¼ å¯¶å¯¶å°ˆå±¬, ğŸ‘µ é•·è¼©å°ˆå±¬, ğŸ¦½ ç„¡éšœç¤™è¼”å…·, ğŸ• å¯µç‰©å°ˆå±¬, â„ï¸ å†¬å­£ä¿æš–, ğŸ–ï¸ ç©æ°´è£å‚™, ğŸ•ï¸ æˆ¶å¤–éœ²ç‡Ÿ, ğŸ’¼ å•†å‹™å·¥ä½œ, ğŸš— äº¤é€šè‡ªé§•ã€‚é™åˆ¶: åªè¦ç´” JSONã€‚`;

                try {
                    let aiResponseText = "";
                    if (provider === 'gemini') {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }], generationConfig: { temperature: 0.2 } })
                        });
                        if (!response.ok) throw new Error(`Gemini éŒ¯èª¤ç¢¼: ${response.status}`);
                        const resultData = await response.json();
                        aiResponseText = resultData.candidates[0].content.parts[0].text;
                    } else {
                        const response = await fetch(`https://api.openai.com/v1/chat/completions`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: "gpt-4o-mini", messages: [{ role: "system", content: "You are a helpful assistant." }, { role: "user", content: promptText }], temperature: 0.2 })
                        });
                        if (!response.ok) throw new Error(`OpenAI éŒ¯èª¤ç¢¼: ${response.status}`);
                        const resultData = await response.json();
                        aiResponseText = resultData.choices[0].message.content;
                    }

                    aiResponseText = aiResponseText.replace(/```json/gi, '').replace(/```/g, '').trim();
                    finalTasks = JSON.parse(aiResponseText);
                    if (!Array.isArray(finalTasks)) throw new Error("æ ¼å¼ä¸æ­£ç¢º");

                } catch (error) {
                    console.error(error);
                    alert("âš ï¸ API å‘¼å«å¤±æ•—æˆ–ç„¡æ•ˆ (å¯èƒ½æ˜¯é¡åº¦è€—ç›¡æˆ– Key éŒ¯èª¤)ã€‚\n\nå°‡è‡ªå‹•ç‚ºæ‚¨åˆ‡æ›è‡³ã€Œå…§å»ºæ¥µé€Ÿæ™ºæ…§å¼•æ“ã€ç”¢ç”Ÿæ¸…å–®ï¼");
                    finalTasks = getRuleBasedTasks(input);
                }
            } else {
                btn.innerHTML = 'âœ¨ å…§å»ºå¼•æ“æ¥µé€Ÿåˆ†æä¸­...';
                await new Promise(r => setTimeout(r, 600)); 
                finalTasks = getRuleBasedTasks(input);
            }

            if (data.checklists.length > 0) {
                const mode = document.querySelector('input[name="magic-mode"]:checked').value;
                if (mode === 'overwrite') data.checklists = []; 
            }

            const targetDate = "ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨";
            let existingDate = data.checklists.find(d => d.date === targetDate);
            if (!existingDate) { data.checklists.push({ date: targetDate, tasks: [] }); existingDate = data.checklists[data.checklists.length - 1]; }
            
            finalTasks.forEach(task => { 
                existingDate.tasks.push({ 
                    id: 't' + Date.now() + Math.random(), 
                    title: task.title || "æœªçŸ¥ç‰©å“", 
                    isCompleted: false, 
                    category: task.category || "ğŸ“ å…¶ä»–é›œé …", 
                    note: task.note || "" 
                }); 
            });

            data.checklists.sort((a, b) => { if (a.date === targetDate) return -1; if (b.date === targetDate) return 1; return a.date.localeCompare(b.date); });
            
            saveData(); renderTasks(); 
            document.getElementById('magic-prompt').value = ''; 
            closeModal('magicModal');
            
            btn.innerHTML = originalBtnText; btn.disabled = false;
        }

        function addNewTask() {
            const dateSelect = document.getElementById('new-date-select');
            let dateInput = dateSelect.value === 'custom' ? document.getElementById('new-date-input').value : dateSelect.value;
            if (dateSelect.value === 'custom' && !dateInput) return alert("è«‹é¸æ“‡æ—¥æœŸå–”ï¼ğŸ—“ï¸");
            
            const catSelect = document.getElementById('new-category-select');
            const catInputEl = document.getElementById('new-category-input');
            let catInput = (catSelect.style.display === 'none' || catSelect.value === 'custom') ? catInputEl.value.trim() : catSelect.value;
            if (!catInput) catInput = "ğŸ“ å…¶ä»–é›œé …"; 

            const titleInput = document.getElementById('new-title').value.trim();
            if (!titleInput) return alert("è«‹è¼¸å…¥ç‰©å“åç¨±ï¼ğŸ“Œ");

            const newTask = { id: 't' + Date.now(), title: titleInput, isCompleted: false, category: catInput, note: document.getElementById('new-note').value.trim() };

            let existingDate = data.checklists.find(d => d.date === dateInput);
            if (existingDate) { existingDate.tasks.push(newTask); } else { data.checklists.push({ date: dateInput, tasks: [newTask] }); }
            
            data.checklists.sort((a, b) => { if (a.date === 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨') return -1; if (b.date === 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨') return 1; return a.date.localeCompare(b.date); });
            saveData(); renderTasks(); document.getElementById('new-title').value = ''; document.getElementById('new-note').value = ''; catInputEl.value = ''; closeModal('addModal');
        }

        // --- ç•«é¢æ¸²æŸ“ ---
        function renderTasks() {
            appDiv.innerHTML = ''; 
            const btnShare = document.getElementById('btn-share');
            const btnClear = document.getElementById('btn-clear');
            
            if(data.checklists.length === 0) {
                btnShare.style.display = 'none'; btnClear.style.display = 'none';
                appDiv.innerHTML = '<div style="text-align:center; padding: 60px 20px; color:#a6b5c0; font-size: 1.1em; line-height: 1.8;">æ¸…å–®ç©ºç©ºçš„å‘¢ â˜ï¸<br>æŒ‰ä¸‹å·¦ä¸‹è§’çš„ ğŸ’¡ è®“ AI ç‚ºæ‚¨æº–å‚™æ¸…å–®å§ï¼</div>';
                return;
            } else {
                btnShare.style.display = 'inline-flex'; btnClear.style.display = 'inline-flex';
            }

            data.checklists.forEach(day => {
                const section = document.createElement('div');
                section.className = 'date-section';
                
                const title = document.createElement('div'); title.className = 'date-title';
                title.innerHTML = day.date === 'ğŸ’ æ™ºæ…§æ‰“åŒ…ç¸½è¡¨' ? `ğŸ’ æ™ºæ…§å¿«é€Ÿç¸½è¡¨` : `ğŸ—“ï¸ ${day.date}`;
                section.appendChild(title);

                const groupedTasks = {};
                day.tasks.forEach(task => { if (!groupedTasks[task.category]) groupedTasks[task.category] = []; groupedTasks[task.category].push(task); });

                Object.keys(groupedTasks).sort().forEach(category => {
                    const style = getCategoryStyle(category);
                    const catHeader = document.createElement('div'); catHeader.className = 'category-header';
                    catHeader.innerHTML = `<span style="background:${style.line}; width:8px; height:16px; border-radius:4px; margin-right:10px; display:inline-block;"></span>${category}`;
                    section.appendChild(catHeader);

                    groupedTasks[category].forEach(task => {
                        const itemDiv = document.createElement('div'); itemDiv.className = 'task-item';
                        const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = task.id; checkbox.checked = task.isCompleted;
                        checkbox.onchange = (e) => { task.isCompleted = e.target.checked; saveData(); renderTasks(); };

                        const checkLabel = document.createElement('label'); checkLabel.className = 'check-icon'; checkLabel.htmlFor = task.id; 
                        const content = document.createElement('div'); content.className = `task-content ${task.isCompleted ? 'completed' : ''}`;
                        const noteHtml = task.note ? `<div class="task-note">${task.note}</div>` : '';

                        content.innerHTML = `<div class="task-title">${task.title} <span class="category-tag" style="background:${style.bg}; color:${style.color};">${category.split(' ')[0]}</span></div>${noteHtml}`;

                        const actionsDiv = document.createElement('div'); actionsDiv.className = 'task-actions';
                        
                        const editBtn = document.createElement('button'); editBtn.className = 'edit-btn'; editBtn.innerHTML = 'âœï¸'; 
                        editBtn.onclick = () => openEditModal(day.date, task.id);
                        
                        const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = 'âœ–'; 
                        // âœ¨ åœ¨é€™è£¡å‚³å…¥ task.title ç¢ºä¿é˜²å‘†å½ˆçª—èƒ½æ­£å¸¸è®€å–åç¨±
                        deleteBtn.onclick = () => deleteTask(day.date, task.id, task.title);

                        actionsDiv.appendChild(editBtn); actionsDiv.appendChild(deleteBtn);
                        itemDiv.appendChild(checkbox); itemDiv.appendChild(checkLabel); itemDiv.appendChild(content); itemDiv.appendChild(actionsDiv);
                        section.appendChild(itemDiv);
                    });
                });
                appDiv.appendChild(section);
            });
        }

        loadData();
        renderTasks();
    </script>
</body>
</html>
